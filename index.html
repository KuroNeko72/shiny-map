<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>訪問先マップ（フィルター機能付き）</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    #filter-panel {
      background: #f4f4f4;
      padding: 10px;
      border-bottom: 1px solid #ccc;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      font-size: 13px;
    }
    .filter-group {
      display: flex;
      flex-direction: column;
    }
    .filter-title {
      font-weight: bold;
      margin-bottom: 4px;
    }
    #map-container {
      display: flex;
      flex: 1;
    }
    #sidebar {
      width: 300px;
      overflow-y: auto;
      border-right: 1px solid #ccc;
      padding: 10px;
      box-sizing: border-box;
      background: #fafafa;
    }
    #map {
      flex: 1;
    }
    .list-item {
      padding: 6px 10px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
    }
    .list-item:hover {
      background-color: #f0f0f0;
    }
    .list-item.active {
      background-color: #d0ebff;
    }
    .district-header {
      font-weight: bold;
      margin-top: 15px;
      margin-bottom: 5px;
      color: #333;
      border-bottom: 1px solid #ddd;
      padding-bottom: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .district-header button {
      font-size: 12px;
      padding: 2px 6px;
      margin-left: 6px;
      background-color: #2ecc71;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .district-container {
      margin-left: 10px;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <div id="filter-panel">
    <div class="filter-group">
      <div class="filter-title">受け取り</div>
      <label><input type="checkbox" class="filter-receive" value="可" checked> 可</label>
      <label><input type="checkbox" class="filter-receive" value="不可" checked> 不可</label>
      <label><input type="checkbox" class="filter-receive" value="検討" checked> 検討</label>
    </div>
    <div class="filter-group">
      <div class="filter-title">配架</div>
      <label><input type="checkbox" class="filter-shelve" value="可能" checked> 可能</label>
      <label><input type="checkbox" class="filter-shelve" value="不可" checked> 不可</label>
      <label><input type="checkbox" class="filter-shelve" value="次回確認" checked> 次回確認</label>
    </div>
    <div class="filter-group">
      <div class="filter-title">未訪問期間</div>
      <label><input type="checkbox" class="filter-days" value="30"> 30日以上</label>
      <label><input type="checkbox" class="filter-days" value="60"> 60日以上</label>
      <label><input type="checkbox" class="filter-days" value="90"> 90日以上</label>
      <label><input type="checkbox" class="filter-days" value="180"> 180日以上</label>
      <label><input type="checkbox" class="filter-days" value="365"> 365日以上</label>
      <label><input type="checkbox" class="filter-days" value="unknown"> 未入力</label>
    </div>
  </div>
  <div id="map-container">
    <div id="sidebar"></div>
    <div id="map"></div>
  </div>

  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBe8z63G6IyDacbjrcN4Yj1ffT7m0U48wg&callback=initMap" async defer></script>
  <script>
    let map;
    let markers = [];
    let infoWindows = [];
    let listItems = [];

    function daysSince(dateStr) {
      if (!dateStr || dateStr === "未入力") return null;
      const today = new Date();
      const date = new Date(dateStr);
      const diff = today - date;
      return Math.floor(diff / (1000 * 60 * 60 * 24));
    }

    function getCheckedValues(className) {
      return Array.from(document.querySelectorAll(`.${className}:checked`)).map(e => e.value);
    }

    function passesFilters(entry) {
      const receiveStatus = entry["受け取り可否"] || "未確認";
      const shelveStatus = entry["配架"] || "未入力";
      const visitRaw = entry["前回訪問"] || "未入力";

      const receiveFilter = getCheckedValues("filter-receive");
      const shelveFilter = getCheckedValues("filter-shelve");
      const daysFilter = getCheckedValues("filter-days");

      const days = daysSince(visitRaw);

      const daysMatch = daysFilter.some(val => {
        if (val === "unknown") return days === null;
        return days !== null && days >= parseInt(val);
      });

      return receiveFilter.includes(receiveStatus) &&
             shelveFilter.includes(shelveStatus) &&
             (daysFilter.length === 0 || daysMatch);
    }

    function updateVisibility() {
      markers.forEach((marker, i) => {
        const visible = passesFilters(marker.entry);
        marker.setVisible(visible);
        listItems[i].style.display = visible ? "" : "none";
      });
    }

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        zoom: 13,
        center: { lat: 35.71006, lng: 139.8107 }
      });

      const sidebar = document.getElementById("sidebar");
      const iconMap = {
        "可": "http://maps.google.com/mapfiles/ms/icons/red-dot.png",
        "不可": "http://maps.google.com/mapfiles/ms/icons/blue-dot.png",
        "検討": "http://maps.google.com/mapfiles/ms/icons/green-dot.png",
        "未確認": "http://maps.google.com/mapfiles/ms/icons/yellow-dot.png"
      };

      fetch("YOUR_JSON_ENDPOINT")
        .then(response => response.json())
        .then(data => {
          const geocoder = new google.maps.Geocoder();

          data.forEach(entry => {
            const name = entry["施設名"];
            const address = entry["住所"];
            const status = entry["受け取り可否"] || "未確認";
            const visit = entry["前回訪問"] || "未入力";
            const shelve = entry["配架"] || "未入力";
            const visitor = entry["訪問者"] || "不明";

            geocoder.geocode({ address }, (results, statusCode) => {
              if (statusCode === "OK") {
                const position = results[0].geometry.location;
                const infoContent = `
                  <div><strong>${name}</strong><br>
                  受け取り可否：${status}<br>
                  配架：${shelve}<br>
                  前回訪問：${visit}<br>
                  訪問者：${visitor}</div>
                `;
                const infoWindow = new google.maps.InfoWindow({ content: infoContent });
                const marker = new google.maps.Marker({
                  map: map,
                  position,
                  title: name,
                  icon: iconMap[status] || iconMap["未確認"]
                });

                marker.entry = entry;
                markers.push(marker);
                infoWindows.push(infoWindow);

                const listItem = document.createElement("div");
                listItem.className = "list-item";
                listItem.textContent = name;
                listItems.push(listItem);
                sidebar.appendChild(listItem);

                marker.addListener("click", () => {
                  infoWindows.forEach(w => w.close());
                  infoWindow.open(map, marker);
                });
                listItem.addEventListener("click", () => {
                  infoWindows.forEach(w => w.close());
                  infoWindow.open(map, marker);
                });

                updateVisibility();
              }
            });
          });
        });

      document.querySelectorAll("#filter-panel input").forEach(input => {
        input.addEventListener("change", updateVisibility);
      });
    }
  </script>
</body>
</html>
