<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>è¨ªå•å…ˆãƒãƒƒãƒ—</title>
    <style>
      body {
        margin: 0;
        font-family: Arial, sans-serif;
        display: flex;
        height: 100vh;
      }
      #sidebar {
        width: 300px;
        overflow-y: auto;
        border-right: 1px solid #ccc;
        padding: 10px;
        box-sizing: border-box;
        background: #fafafa;
      }
      #map {
        flex: 1;
      }
      .list-item {
        padding: 6px 10px;
        cursor: pointer;
        border-bottom: 1px solid #eee;
      }
      .list-item:hover {
        background-color: #f0f0f0;
      }
      .list-item.selected {
        background-color: #ffeaa7;
        font-weight: bold;
      }
      .district-header {
        font-weight: bold;
        margin-top: 15px;
        margin-bottom: 5px;
        color: #333;
        border-bottom: 1px solid #ddd;
        padding-bottom: 4px;
      }
      .sidebar-buttons {
        display: flex;
        justify-content: space-between;
        gap: 5px;
        margin-bottom: 15px;
      }
      .sidebar-buttons button {
        flex: 1;
        padding: 6px;
        border: none;
        border-radius: 4px;
        color: white;
        cursor: pointer;
        font-size: 13px;
        white-space: nowrap;
      }
      #refresh-button {
        background-color: #3498db;
      }
      #refresh-button:hover {
        background-color: #2980b9;
      }
      #close-button {
        background-color: #e74c3c;
      }
      #close-button:hover {
        background-color: #c0392b;
      }
      #showall-button {
        background-color: #2ecc71;
      }
      #showall-button:hover {
        background-color: #27ae60;
      }
    </style>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBe8z63G6IyDacbjrcN4Yj1ffT7m0U48wg&callback=initMap" async defer></script>
    <script>
      let map;
      let markers = [];
      let infoWindows = [];
      let selectedListItem = null;

      function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
          zoom: 13,
          center: { lat: 35.71006, lng: 139.8107 }
        });

        reloadMapData();
      }

      function reloadMapData() {
        clearMapAndSidebar();

        const icons = {
          "å¯": "http://maps.google.com/mapfiles/ms/icons/red-dot.png",
          "ä¸å¯": "http://maps.google.com/mapfiles/ms/icons/blue-dot.png",
          "æœªç¢ºèª": "http://maps.google.com/mapfiles/ms/icons/green-dot.png"
        };

        fetch("https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLi_MUyKuabYCEacuEOQr9DhUDiB0t0yRuKdLL4NMRT-DW4MCPN-pgzOmpwyPbMmYVnfu8Y7n4XX4EAsK454yx3MhffWkZcJ-zpg1kKKHxoSQ9yhD0mwtxSYAnWFBKVcMWgsSbC8xbZ_yzjI4mjSFiXga6V88L8vRyO9_U3J9XeyEEXCmI0tfFP27RWjgB-Z8luFgpo6k1pKJypR8mXXfCPJdkkuN_cP634KmNFjUOux8_gJbDMjIOCOGEFdr2UDiitCIDqzTtJcHXAuYxyvo8Gc4FlePEWGzWJrm346&lib=MavVMtVIJN2j1dWEVARyyVyNB014Mn1gM")
          .then(response => response.json())
          .then(data => {
            createMarkers(data, icons);
          });
      }

      function clearMapAndSidebar() {
        markers.forEach(marker => marker.setMap(null));
        markers = [];
        infoWindows.forEach(win => win.close());
        infoWindows = [];
        selectedListItem = null;

        const sidebar = document.getElementById('sidebar');
        sidebar.innerHTML = '';
      }

      function createMarkers(data, icons) {
        const geocoder = new google.maps.Geocoder();
        const sidebar = document.getElementById('sidebar');
        const grouped = {};

        // ğŸ”˜ çµ±ä¸€ãƒœã‚¿ãƒ³é…ç½®
        const buttonContainer = document.createElement("div");
        buttonContainer.className = "sidebar-buttons";

        const refreshBtn = document.createElement("button");
        refreshBtn.id = "refresh-button";
        refreshBtn.textContent = "ğŸ”„ æ›´æ–°";
        refreshBtn.addEventListener("click", () => reloadMapData());

        const closeBtn = document.createElement("button");
        closeBtn.id = "close-button";
        closeBtn.textContent = "âŒ é–‰ã˜ã‚‹";
        closeBtn.addEventListener("click", () => closeAllInfoWindows());

        const showAllBtn = document.createElement("button");
        showAllBtn.id = "showall-button";
        showAllBtn.textContent = "ğŸ“Œ ä¸€æ‹¬è¡¨ç¤º";
        showAllBtn.addEventListener("click", () => showAllInfoWindows());

        buttonContainer.appendChild(refreshBtn);
        buttonContainer.appendChild(closeBtn);
        buttonContainer.appendChild(showAllBtn);
        sidebar.appendChild(buttonContainer);

        // åœ°åŒºã‚°ãƒ«ãƒ¼ãƒ—åŒ–
        data.forEach(entry => {
          const district = entry['åºƒå ±åœ°åŒº'] || "ãã®ä»–";
          if (!grouped[district]) grouped[district] = [];
          grouped[district].push(entry);
        });

        for (const district in grouped) {
          const header = document.createElement("div");
          header.className = "district-header";
          header.textContent = `ã€${district}ã€‘`;
          sidebar.appendChild(header);

          grouped[district].forEach(entry => {
            const name = entry['æ–½è¨­å'];
            const address = entry['ä½æ‰€'];
            const query = address || name;
            const status = entry['å—ã‘å–ã‚Šå¯å¦'] || "æœªç¢ºèª";
            const rawDate = entry['å‰å›è¨ªå•'];
            const visitor = entry['è¨ªå•è€…'] || "ä¸æ˜";

            if (!query) return;

            let visitDate = "æœªå…¥åŠ›";
            if (rawDate && rawDate !== "æœªå…¥åŠ›") {
              const d = new Date(rawDate);
              const yyyy = d.getFullYear();
              const mm = ("0" + (d.getMonth() + 1)).slice(-2);
              const dd = ("0" + d.getDate()).slice(-2);
              visitDate = `${yyyy}/${mm}/${dd}`;
            }

            geocoder.geocode({ address: query }, (results, statusCode) => {
              if (statusCode === "OK") {
                const position = results[0].geometry.location;
                const icon = icons[status] || icons["æœªç¢ºèª"];
                const infoWindow = new google.maps.InfoWindow({
                  content: `
                    <div style="text-align:left;line-height:1.4;">
                      <strong>${name}</strong><br>
                      å—ã‘å–ã‚Šå¯å¦ï¼š${status}<br>
                      å‰å›è¨ªå•ï¼š${visitDate}ã€€è¨ªå•è€…ï¼š${visitor}
                    </div>`
                });

                const marker = new google.maps.Marker({
                  map: map,
                  position: position,
                  title: name,
                  icon: icon
                });

                const item = document.createElement("div");
                item.className = "list-item";
                item.textContent = name;

                marker.addListener("click", () => {
                  closeAllInfoWindows();
                  map.panTo(marker.getPosition());
                  infoWindow.open(map, marker);
                  highlightSelectedItem(item);
                });

                item.addEventListener("click", () => {
                  closeAllInfoWindows();
                  map.panTo(marker.getPosition());
                  map.setZoom(16);
                  infoWindow.open(map, marker);
                  highlightSelectedItem(item);
                });

                markers.push(marker);
                infoWindows.push(infoWindow);
                sidebar.appendChild(item);
              } else {
                console.error("ã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°å¤±æ•—: " + statusCode + "ï¼ˆæ¤œç´¢èªå¥: " + query + "ï¼‰");
              }
            });
          });
        }
      }

      function highlightSelectedItem(newItem) {
        if (selectedListItem) {
          selectedListItem.classList.remove("selected");
        }
        newItem.classList.add("selected");
        selectedListItem = newItem;
      }

      function closeAllInfoWindows() {
        infoWindows.forEach(win => win.close());
      }

      function showAllInfoWindows() {
        infoWindows.forEach((win, index) => {
          win.open(map, markers[index]);
        });
      }
    </script>
  </head>
  <body>
    <div id="sidebar"></div>
    <div id="map"></div>
  </body>
</html>
