<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>訪問先マップ</title>
    <style>
      body {
        margin: 0;
        font-family: Arial, sans-serif;
        display: flex;
        height: 100vh;
      }
      #sidebar {
        width: 300px;
        overflow-y: auto;
        border-right: 1px solid #ccc;
        padding: 10px;
        box-sizing: border-box;
      }
      #map {
        flex: 1;
      }
      .list-item {
        padding: 6px 10px;
        cursor: pointer;
        border-bottom: 1px solid #eee;
      }
      .list-item:hover {
        background-color: #f0f0f0;
      }
    </style>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBe8z63G6IyDacbjrcN4Yj1ffT7m0U48wg&callback=initMap" async defer></script>
    <script>
      let map;
      let markers = [];

      function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
          zoom: 13,
          center: { lat: 35.71006, lng: 139.8107 }
        });

        const icons = {
          "可": "http://maps.google.com/mapfiles/ms/icons/red-dot.png",
          "不可": "http://maps.google.com/mapfiles/ms/icons/blue-dot.png",
          "未確認": "http://maps.google.com/mapfiles/ms/icons/green-dot.png"
        };

        fetch("https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLi_MUyKuabYCEacuEOQr9DhUDiB0t0yRuKdLL4NMRT-DW4MCPN-pgzOmpwyPbMmYVnfu8Y7n4XX4EAsK454yx3MhffWkZcJ-zpg1kKKHxoSQ9yhD0mwtxSYAnWFBKVcMWgsSbC8xbZ_yzjI4mjSFiXga6V88L8vRyO9_U3J9XeyEEXCmI0tfFP27RWjgB-Z8luFgpo6k1pKJypR8mXXfCPJdkkuN_cP634KmNFjUOux8_gJbDMjIOCOGEFdr2UDiitCIDqzTtJcHXAuYxyvo8Gc4FlePEWGzWJrm346&lib=MavVMtVIJN2j1dWEVARyyVyNB014Mn1gM")
          .then(response => response.json())
          .then(data => {
            createMarkers(data);
          });

        function createMarkers(data) {
          const geocoder = new google.maps.Geocoder();
          const sidebar = document.getElementById('sidebar');

          data.forEach(entry => {
            const name = entry['施設名'];
            const address = entry['住所'];
            const query = address || name;
            const status = entry['受け取り可否'] || "未確認";
            const rawDate = entry['前回訪問'];
            const visitor = entry['訪問者'] || "不明";

            if (!query) return;

            let visitDate = "未入力";
            if (rawDate && rawDate !== "未入力") {
              const d = new Date(rawDate);
              const yyyy = d.getFullYear();
              const mm = ("0" + (d.getMonth() + 1)).slice(-2);
              const dd = ("0" + d.getDate()).slice(-2);
              visitDate = `${yyyy}/${mm}/${dd}`;
            }

            geocoder.geocode({ address: query }, (results, status) => {
              if (status === "OK") {
                const position = results[0].geometry.location;
                const icon = icons[status] || icons["未確認"];
                const infoWindow = new google.maps.InfoWindow({
                  content: `
                    <div style="text-align:left;line-height:1.4;">
                      <strong>${name}</strong><br>
                      受け取り可否：${status}<br>
                      前回訪問：${visitDate}　訪問者：${visitor}
                    </div>`
                });

                const marker = new google.maps.Marker({
                  map: map,
                  position: position,
                  title: name,
                  icon: icon
                });

                marker.addListener("click", () => {
                  map.panTo(marker.getPosition());
                  infoWindow.open(map, marker);
                });

                markers.push(marker);

                // サイドバーに施設名追加
                const item = document.createElement("div");
                item.className = "list-item";
                item.textContent = name;
                item.addEventListener("click", () => {
                  map.panTo(marker.getPosition());
                  map.setZoom(16);
                  infoWindow.open(map, marker);
                });
                sidebar.appendChild(item);

              } else {
                console.error("ジオコーディング失敗: " + status + "（検索語句: " + query + "）");
              }
            });
          });
        }
      }
    </script>
  </head>
  <body>
    <div id="sidebar"></div>
    <div id="map"></div>
  </body>
</html>
