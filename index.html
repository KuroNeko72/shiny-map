<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>è¨ªå•å…ˆãƒãƒƒãƒ—</title>
    <style>
      body {
        margin: 0;
        font-family: Arial, sans-serif;
        display: flex;
        height: 100vh;
      }
      #sidebar {
        width: 300px;
        overflow-y: auto;
        border-right: 1px solid #ccc;
        padding: 10px;
        box-sizing: border-box;
        background: #fafafa;
      }
      #map {
        flex: 1;
      }
      .list-item {
        padding: 6px 10px;
        cursor: pointer;
        border-bottom: 1px solid #eee;
      }
      .list-item:hover {
        background-color: #f0f0f0;
      }
      .list-item.active {
        background-color: #d0ebff;
      }
      .district-header {
        font-weight: bold;
        margin-top: 15px;
        margin-bottom: 5px;
        color: #333;
        border-bottom: 1px solid #ddd;
        padding-bottom: 4px;
      }
    </style>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBe8z63G6IyDacbjrcN4Yj1ffT7m0U48wg&callback=initMap" async defer></script>
    <script>
      let map;
      let markers = [];
      let infoWindows = [];
      let currentlyOpenWindow = null;
      let currentlyActiveItem = null;

      function initMap() {
        map = new google.maps.Map(document.getElementById("map"), {
          zoom: 13,
          center: { lat: 35.71006, lng: 139.8107 },
        });

        const icons = {
          å¯: "http://maps.google.com/mapfiles/ms/icons/red-dot.png",
          ä¸å¯: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png",
          æœªç¢ºèª: "http://maps.google.com/mapfiles/ms/icons/green-dot.png",
        };

        fetch("https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLi_MUyKuabYCEacuEOQr9DhUDiB0t0yRuKdLL4NMRT-DW4MCPN-pgzOmpwyPbMmYVnfu8Y7n4XX4EAsK454yx3MhffWkZcJ-zpg1kKKHxoSQ9yhD0mwtxSYAnWFBKVcMWgsSbC8xbZ_yzjI4mjSFiXga6V88L8vRyO9_U3J9XeyEEXCmI0tfFP27RWjgB-Z8luFgpo6k1pKJypR8mXXfCPJdkkuN_cP634KmNFjUOux8_gJbDMjIOCOGEFdr2UDiitCIDqzTtJcHXAuYxyvo8Gc4FlePEWGzWJrm346&lib=MavVMtVIJN2j1dWEVARyyVyNB014Mn1gM")
          .then((response) => response.json())
          .then((data) => {
            createMarkers(data);
          });

        function createMarkers(data) {
          const geocoder = new google.maps.Geocoder();
          const sidebar = document.getElementById("sidebar");
          const grouped = {};

          data.forEach((entry) => {
            const district = entry["åºƒå ±åœ°åŒº"] || "ãã®ä»–";
            if (!grouped[district]) grouped[district] = [];
            grouped[district].push(entry);
          });

          // ãƒœã‚¿ãƒ³
          const buttonContainer = document.createElement("div");
          buttonContainer.style.display = "flex";
          buttonContainer.style.justifyContent = "space-between";
          buttonContainer.style.gap = "4px";
          buttonContainer.style.marginBottom = "10px";

          const openBtn = document.createElement("button");
          openBtn.textContent = "âœ… å¹ãå‡ºã—ã‚’ã™ã¹ã¦é–‹ã";
          Object.assign(openBtn.style, {
            flex: "1",
            padding: "6px 0",
            backgroundColor: "#3498db",
            color: "white",
            border: "none",
            borderRadius: "4px",
            cursor: "pointer",
          });
          openBtn.addEventListener("click", () => {
            openAllInfoWindows();
          });

          const closeBtn = document.createElement("button");
          closeBtn.textContent = "âŒ å¹ãå‡ºã—ã‚’ã™ã¹ã¦é–‰ã˜ã‚‹";
          Object.assign(closeBtn.style, {
            flex: "1",
            padding: "6px 0",
            backgroundColor: "#e74c3c",
            color: "white",
            border: "none",
            borderRadius: "4px",
            cursor: "pointer",
          });
          closeBtn.addEventListener("click", () => {
            closeAllInfoWindows();
          });

          buttonContainer.appendChild(openBtn);
          buttonContainer.appendChild(closeBtn);
          sidebar.prepend(buttonContainer);

          let geocodeCount = 0;
          const entriesWithAddress = Object.values(grouped)
            .flat()
            .filter((e) => e["ä½æ‰€"]);
          const totalEntries = entriesWithAddress.length;

          for (const district in grouped) {
            const entries = grouped[district].filter((e) => e["ä½æ‰€"]);
            if (entries.length === 0) continue;

            const header = document.createElement("div");
            header.className = "district-header";
            header.textContent = `ã€${district}ã€‘`;
            sidebar.appendChild(header);

            entries.forEach((entry) => {
              const name = entry["æ–½è¨­å"];
              const address = entry["ä½æ‰€"];
              if (!address) return;

              const status = entry["å—ã‘å–ã‚Šå¯å¦"] || "æœªç¢ºèª";
              const rawDate = entry["å‰å›è¨ªå•"];
              const visitor = entry["è¨ªå•è€…"] || "ä¸æ˜";

              let visitDate = "æœªå…¥åŠ›";
              if (rawDate && rawDate !== "æœªå…¥åŠ›") {
                const d = new Date(rawDate);
                const yyyy = d.getFullYear();
                const mm = ("0" + (d.getMonth() + 1)).slice(-2);
                const dd = ("0" + d.getDate()).slice(-2);
                visitDate = `${yyyy}/${mm}/${dd}`;
              }

              geocoder.geocode({ address: address }, (results, statusCode) => {
                geocodeCount++;
                if (statusCode === "OK") {
                  const position = results[0].geometry.location;
                  const icon = icons[status] || icons["æœªç¢ºèª"];
                  const infoWindow = new google.maps.InfoWindow({
                    content: `
                      <div style="max-width: 250px;">
                        <div style="font-weight: bold; font-size: 14px; margin-bottom: 4px;">
                          ${name}
                        </div>
                        <div style="font-size: 13px; line-height: 1.4;">
                          å—ã‘å–ã‚Šå¯å¦ï¼š${status}<br>
                          å‰å›è¨ªå•ï¼š${visitDate}ã€€è¨ªå•è€…ï¼š${visitor}
                        </div>
                      </div>`,
                  });

                  const marker = new google.maps.Marker({
                    map: map,
                    position: position,
                    title: name,
                    icon: icon,
                  });

                  // ğŸ” ãƒ”ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚ï¼šãƒˆã‚°ãƒ«è¡¨ç¤ºã€ç”»é¢ç§»å‹•ãªã—
                  marker.addListener("click", () => {
                    if (currentlyOpenWindow === infoWindow) {
                      infoWindow.close();
                      currentlyOpenWindow = null;
                      if (currentlyActiveItem) {
                        currentlyActiveItem.classList.remove("active");
                        currentlyActiveItem = null;
                      }
                    } else {
                      if (currentlyOpenWindow) currentlyOpenWindow.close();
                      infoWindow.open(map, marker);
                      currentlyOpenWindow = infoWindow;

                      if (currentlyActiveItem)
                        currentlyActiveItem.classList.remove("active");
                      item.classList.add("active");
                      currentlyActiveItem = item;
                    }
                  });

                  const item = document.createElement("div");
                  item.className = "list-item";
                  item.textContent = name;
                  item.addEventListener("click", () => {
                    if (currentlyOpenWindow === infoWindow) {
                      infoWindow.close();
                      currentlyOpenWindow = null;
                      item.classList.remove("active");
                      currentlyActiveItem = null;
                    } else {
                      if (currentlyOpenWindow) currentlyOpenWindow.close();
                      infoWindow.open(map, marker);
                      currentlyOpenWindow = infoWindow;

                      if (currentlyActiveItem)
                        currentlyActiveItem.classList.remove("active");
                      item.classList.add("active");
                      currentlyActiveItem = item;
                    }
                  });

                  markers.push(marker);
                  infoWindows.push(infoWindow);
                  sidebar.appendChild(item);
                }

                if (geocodeCount === totalEntries) {
                  openAllInfoWindows();
                }
              });
            });
          }

          function closeAllInfoWindows() {
            infoWindows.forEach((win) => win.close());
            currentlyOpenWindow = null;
            if (currentlyActiveItem)
              currentlyActiveItem.classList.remove("active");
            currentlyActiveItem = null;
          }

          function openAllInfoWindows() {
            closeAllInfoWindows();
            const bounds = new google.maps.LatLngBounds();
            markers.forEach((marker) => bounds.extend(marker.getPosition()));
            map.fitBounds(bounds);
            infoWindows.forEach((win, idx) => {
              win.open(map, markers[idx]);
            });
          }
        }
      }
    </script>
  </head>
  <body>
    <div id="sidebar"></div>
    <div id="map"></div>
  </body>
</html>
