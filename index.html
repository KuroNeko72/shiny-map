<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>è¨ªå•å…ˆãƒãƒƒãƒ—ï¼ˆæ¨™æº–InfoWindowï¼‰</title>
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    <style>
      body { margin: 0; font-family: Arial, sans-serif; display: flex; height: 100vh; }
      #sidebar {
        width: 300px; overflow-y: auto; border-right: 1px solid #ccc;
        padding: 10px; box-sizing: border-box; background: #fafafa;
      }
      #map { flex: 1; }
      .list-item {
        padding: 6px 10px; cursor: pointer; border-bottom: 1px solid #eee;
      }
      .list-item:hover { background-color: #f0f0f0; }
      .list-item.selected {
        background-color: #ffeaa7; font-weight: bold;
      }
      .district-header {
        font-weight: bold; margin-top: 15px; margin-bottom: 5px;
        color: #333; border-bottom: 1px solid #ddd; padding-bottom: 4px;
      }
      .sidebar-buttons {
        display: flex; justify-content: space-between;
        gap: 5px; margin-bottom: 15px;
      }
      .sidebar-buttons button {
        flex: 1; padding: 6px; border: none; border-radius: 4px;
        color: white; cursor: pointer; font-size: 13px; white-space: nowrap;
      }
      #refresh-button { background-color: #3498db; }
      #close-button { background-color: #e74c3c; }
      #showall-button { background-color: #2ecc71; }
    </style>
    <script>
      function initMap() {
        const map = new google.maps.Map(document.getElementById("map"), {
          zoom: 13,
          center: { lat: 35.71006, lng: 139.8107 }
        });

        let markers = [];
        let infoWindows = [];
        let selectedListItem = null;

        function highlightSelectedItem(item) {
          if (selectedListItem) selectedListItem.classList.remove("selected");
          item.classList.add("selected");
          selectedListItem = item;
        }

        function closeAllInfoWindows() {
          infoWindows.forEach(win => win.close());
        }

        function clearAll() {
          markers.forEach(marker => marker.setMap(null));
          markers = [];
          infoWindows = [];
          document.getElementById("sidebar").innerHTML = '';
        }

        function reloadMapData() {
          clearAll();

          fetch("https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLi_MUyKuabYCEacuEOQr9DhUDiB0t0yRuKdLL4NMRT-DW4MCPN-pgzOmpwyPbMmYVnfu8Y7n4XX4EAsK454yx3MhffWkZcJ-zpg1kKKHxoSQ9yhD0mwtxSYAnWFBKVcMWgsSbC8xbZ_yzjI4mjSFiXga6V88L8vRyO9_U3J9XeyEEXCmI0tfFP27RWjgB-Z8luFgpo6k1pKJypR8mXXfCPJdkkuN_cP634KmNFjUOux8_gJbDMjIOCOGEFdr2UDiitCIDqzTtJcHXAuYxyvo8Gc4FlePEWGzWJrm346&lib=MavVMtVIJN2j1dWEVARyyVyNB014Mn1gM")
            .then(res => res.json())
            .then(data => {
              const geocoder = new google.maps.Geocoder();
              const sidebar = document.getElementById("sidebar");
              const grouped = {};

              // ãƒœã‚¿ãƒ³è¡Œ
              const btnRow = document.createElement("div");
              btnRow.className = "sidebar-buttons";

              const refresh = document.createElement("button");
              refresh.id = "refresh-button";
              refresh.textContent = "ğŸ”„ æ›´æ–°";
              refresh.onclick = reloadMapData;

              const close = document.createElement("button");
              close.id = "close-button";
              close.textContent = "âŒ é–‰ã˜ã‚‹";
              close.onclick = closeAllInfoWindows;

              const show = document.createElement("button");
              show.id = "showall-button";
              show.textContent = "ğŸ“Œ ä¸€æ‹¬è¡¨ç¤º";
              show.onclick = () => {
                infoWindows.forEach(iw => iw.open(map));
                if (selectedListItem) {
                  selectedListItem.classList.remove("selected");
                  selectedListItem = null;
                }
              };

              btnRow.append(refresh, close, show);
              sidebar.appendChild(btnRow);

              // ãƒ‡ãƒ¼ã‚¿ã‚’åºƒå ±åœ°åŒºã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
              data.forEach(entry => {
                const district = entry["åºƒå ±åœ°åŒº"] || "ãã®ä»–";
                if (!grouped[district]) grouped[district] = [];
                grouped[district].push(entry);
              });

              for (const district in grouped) {
                const header = document.createElement("div");
                header.className = "district-header";
                header.textContent = `ã€${district}ã€‘`;
                sidebar.appendChild(header);

                grouped[district].forEach(entry => {
                  const name = entry["æ–½è¨­å"];
                  const address = entry["ä½æ‰€"];
                  const status = entry["å—ã‘å–ã‚Šå¯å¦"] || "æœªç¢ºèª";
                  const rawDate = entry["å‰å›è¨ªå•"];
                  const visitor = entry["è¨ªå•è€…"] || "ä¸æ˜";

                  if (!name && !address) return;

                  const visitDate = rawDate && rawDate !== "æœªå…¥åŠ›"
                    ? new Date(rawDate).toISOString().split("T")[0].replace(/-/g, "/")
                    : "æœªå…¥åŠ›";

                  const item = document.createElement("div");
                  item.className = "list-item";
                  item.textContent = name;
                  sidebar.appendChild(item);

                  const infoContent = `
                    <div style="white-space:pre-line; font-size:13px;">
                      ${name}
å—ã‘å–ã‚Šå¯å¦: ${status}
å‰å›è¨ªå•: ${visitDate}
è¨ªå•è€…: ${visitor}
                    </div>`;

                  geocoder.geocode({ address: address || name }, (results, statusCode) => {
                    if (statusCode === "OK") {
                      const position = results[0].geometry.location;
                      const marker = new google.maps.Marker({
                        position,
                        map,
                        title: name
                      });

                      const infoWindow = new google.maps.InfoWindow({
                        content: infoContent
                      });

                      marker.addListener("click", () => {
                        closeAllInfoWindows();
                        infoWindow.open(map, marker);
                        highlightSelectedItem(item);
                      });

                      item.addEventListener("click", () => {
                        closeAllInfoWindows();
                        infoWindow.open(map, marker);
                        highlightSelectedItem(item);
                      });

                      markers.push(marker);
                      infoWindows.push(infoWindow);
                    }
                  });
                });
              }
            });
        }

        reloadMapData();
      }
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBe8z63G6IyDacbjrcN4Yj1ffT7m0U48wg&callback=initMap" async defer></script>
  </head>
  <body>
    <div id="sidebar"></div>
    <div id="map"></div>
  </body>
</html>
