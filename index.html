<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>訪問先マップ（フィルター機能付き）</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      display: flex;
      height: 100vh;
    }
    #sidebar {
      width: 320px;
      overflow-y: auto;
      border-right: 1px solid #ccc;
      padding: 10px;
      box-sizing: border-box;
      background: #fafafa;
    }
    #map {
      flex: 1;
    }
    .list-item {
      padding: 6px 10px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
    }
    .list-item:hover {
      background-color: #f0f0f0;
    }
    .list-item.active {
      background-color: #d0ebff;
    }
    .district-header {
      font-weight: bold;
      margin-top: 15px;
      margin-bottom: 5px;
      color: #333;
      border-bottom: 1px solid #ddd;
      padding-bottom: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .district-header button {
      font-size: 12px;
      padding: 2px 6px;
      margin-left: 6px;
      background-color: #2ecc71;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .district-container {
      margin-left: 10px;
      margin-bottom: 10px;
    }
    .top-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-bottom: 10px;
    }
    .top-buttons button {
      flex: 1;
      padding: 6px 0;
      border: none;
      border-radius: 4px;
      color: white;
      cursor: pointer;
    }
    .open-all { background-color: #3498db; }
    .close-all { background-color: #e74c3c; }
    .filters {
      margin-bottom: 10px;
      font-size: 13px;
    }
    .filters label {
      display: block;
      margin-bottom: 4px;
    }
  </style>
</head>
<body>
  <div id="sidebar">
    <div class="filters">
      <strong>【フィルター】</strong>
      <label><input type="checkbox" class="receive-filter" value="可" checked> 受け取り：可</label>
      <label><input type="checkbox" class="receive-filter" value="不可" checked> 受け取り：不可</label>
      <label><input type="checkbox" class="receive-filter" value="検討" checked> 受け取り：検討</label>
      <label><input type="checkbox" class="shelve-filter" value="可能" checked> 配架：可能</label>
      <label><input type="checkbox" class="shelve-filter" value="不可" checked> 配架：不可</label>
      <label><input type="checkbox" class="shelve-filter" value="次回確認" checked> 配架：次回確認</label>
      <label>訪問経過：
        <select id="days-filter">
          <option value="0">すべて表示</option>
          <option value="30">30日未満を除外</option>
          <option value="60">60日未満を除外</option>
          <option value="90">90日未満を除外</option>
          <option value="180">半年未満を除外</option>
          <option value="365">1年未満を除外</option>
        </select>
      </label>
    </div>
    <div class="top-buttons">
      <button class="open-all">✅ すべて表示</button>
      <button class="close-all">❌ すべて閉じる</button>
    </div>
  </div>
  <div id="map"></div>

  <script>
    let map;
    let markers = [];
    let infoWindows = [];
    let currentlyOpenWindow = null;
    let currentlyActiveItem = null;

    function getFilters() {
      const receive = [...document.querySelectorAll(".receive-filter:checked")].map(e => e.value);
      const shelve = [...document.querySelectorAll(".shelve-filter:checked")].map(e => e.value);
      const days = parseInt(document.getElementById("days-filter").value);
      return { receive, shelve, days };
    }

    function isVisible(entry, filters) {
      const receive = entry["資料受取"] || "未確認";
      const shelve = entry["配架"] || "未入力";
      const rawDate = entry["前回訪問"];

      let visitOK = true;
      if (filters.days > 0 && rawDate && rawDate !== "未入力") {
        const visitDate = new Date(rawDate);
        const now = new Date();
        const diff = (now - visitDate) / (1000 * 60 * 60 * 24);
        visitOK = diff >= filters.days;
      }
      return filters.receive.includes(receive) && filters.shelve.includes(shelve) && visitOK;
    }

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        zoom: 13,
        center: { lat: 35.71006, lng: 139.8107 }
      });

      const icons = {
        "可": "http://maps.google.com/mapfiles/ms/icons/red-dot.png",
        "不可": "http://maps.google.com/mapfiles/ms/icons/blue-dot.png",
        "検討": "http://maps.google.com/mapfiles/ms/icons/green-dot.png"
      };

      fetch("https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLi_MUyKuabYCEacuEOQr9DhUDiB0t0yRuKdLL4NMRT-DW4MCPN-pgzOmpwyPbMmYVnfu8Y7n4XX4EAsK454yx3MhffWkZcJ-zpg1kKKHxoSQ9yhD0mwtxSYAnWFBKVcMWgsSbC8xbZ_yzjI4mjSFiXga6V88L8vRyO9_U3J9XeyEEXCmI0tfFP27RWjgB-Z8luFgpo6k1pKJypR8mXXfCPJdkkuN_cP634KmNFjUOux8_gJbDMjIOCOGEFdr2UDiitCIDqzTtJcHXAuYxyvo8Gc4FlePEWGzWJrm346&lib=MavVMtVIJN2j1dWEVARyyVyNB014Mn1gM")
        .then(res => res.json())
        .then(data => {
          const geocoder = new google.maps.Geocoder();
          const sidebar = document.getElementById("sidebar");

          document.querySelector(".open-all").onclick = () => infoWindows.forEach((w, i) => w.open(map, markers[i]));
          document.querySelector(".close-all").onclick = () => {
            infoWindows.forEach(w => w.close());
            if (currentlyActiveItem) currentlyActiveItem.classList.remove("active");
            currentlyOpenWindow = null;
            currentlyActiveItem = null;
          };

          const grouped = {};
          data.forEach(e => {
            const d = e["広報地区"] || "その他";
            if (!grouped[d]) grouped[d] = [];
            grouped[d].push(e);
          });

          const filters = getFilters();
          for (const district in grouped) {
            const entries = grouped[district].filter(e => isVisible(e, filters));
            if (entries.length === 0) continue;

            const header = document.createElement("div");
            header.className = "district-header";
            header.innerHTML = `<span>【${district}】</span>`;
            sidebar.appendChild(header);

            const container = document.createElement("div");
            container.className = "district-container";
            sidebar.appendChild(container);

            entries.forEach(entry => {
              const name = entry["施設名"];
              const address = entry["住所"];
              if (!address) return;
              const status = entry["資料受取"] || "未確認";
              const shelving = entry["配架"] || "未入力";
              const visitor = entry["訪問者"] || "不明";
              const rawDate = entry["前回訪問"];
              const visitDate = rawDate && rawDate !== "未入力" ? new Date(rawDate).toLocaleDateString() : "未入力";

              geocoder.geocode({ address }, (results, status) => {
                if (status === "OK") {
                  const pos = results[0].geometry.location;
                  const info = new google.maps.InfoWindow({
                    content: `<div style="font-size:13px"><b>${name}</b><br>受け取り：${status}<br>配架：${shelving}<br>前回訪問：${visitDate}（${visitor}）</div>`
                  });

                  const marker = new google.maps.Marker({
                    map: map,
                    position: pos,
                    title: name,
                    icon: icons[status] || icons["検討"]
                  });

                  const item = document.createElement("div");
                  item.className = "list-item";
                  item.textContent = name;
                  item.onclick = () => {
                    if (currentlyOpenWindow) currentlyOpenWindow.close();
                    info.open(map, marker);
                    currentlyOpenWindow = info;
                    if (currentlyActiveItem) currentlyActiveItem.classList.remove("active");
                    item.classList.add("active");
                    currentlyActiveItem = item;
                  };
                  marker.addListener("click", item.onclick);

                  markers.push(marker);
                  infoWindows.push(info);
                  container.appendChild(item);
                }
              });
            });
          }
        });
    }

    window.initMap = initMap;
  </script>

  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBe8z63G6IyDacbjrcN4Yj1ffT7m0U48wg&callback=initMap" async defer></script>
</body>
</html>
