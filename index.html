<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>訪問先マップ</title>
    <style>
      body {
        margin: 0;
        font-family: Arial, sans-serif;
        display: flex;
        height: 100vh;
      }
      #sidebar {
        width: 300px;
        overflow-y: auto;
        border-right: 1px solid #ccc;
        padding: 10px;
        box-sizing: border-box;
        background: #fafafa;
      }
      #map {
        flex: 1;
      }
      .list-item {
        padding: 6px 10px;
        cursor: pointer;
        border-bottom: 1px solid #eee;
      }
      .list-item:hover {
        background-color: #f0f0f0;
      }
      .district-header {
        font-weight: bold;
        margin-top: 15px;
        margin-bottom: 5px;
        color: #333;
        border-bottom: 1px solid #ddd;
        padding-bottom: 4px;
      }
      #close-button {
        display: block;
        margin: 10px auto 15px;
        padding: 6px 12px;
        background-color: #e74c3c;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      #close-button:hover {
        background-color: #c0392b;
      }
    </style>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBe8z63G6IyDacbjrcN4Yj1ffT7m0U48wg&callback=initMap" async defer></script>
    <script>
      let map;
      let markers = [];
      let infoWindows = [];

      function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
          zoom: 13,
          center: { lat: 35.71006, lng: 139.8107 }
        });

        fetch("https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLi_MUyKuabYCEacuEOQr9DhUDiB0t0yRuKdLL4NMRT-DW4MCPN-pgzOmpwyPbMmYVnfu8Y7n4XX4EAsK454yx3MhffWkZcJ-zpg1kKKHxoSQ9yhD0mwtxSYAnWFBKVcMWgsSbC8xbZ_yzjI4mjSFiXga6V88L8vRyO9_U3J9XeyEEXCmI0tfFP27RWjgB-Z8luFgpo6k1pKJypR8mXXfCPJdkkuN_cP634KmNFjUOux8_gJbDMjIOCOGEFdr2UDiitCIDqzTtJcHXAuYxyvo8Gc4FlePEWGzWJrm346&lib=MavVMtVIJN2j1dWEVARyyVyNB014Mn1gM")
          .then(response => response.json())
          .then(data => {
            createMarkers(data);
          });

        function createMarkers(data) {
          const geocoder = new google.maps.Geocoder();
          const sidebar = document.getElementById('sidebar');
          const grouped = {};

          // グループ化（広報地区ごと）
          data.forEach(entry => {
            const district = entry['広報地区'] || "その他";
            if (!grouped[district]) grouped[district] = [];
            grouped[district].push(entry);
          });

          for (const district in grouped) {
            const header = document.createElement("div");
            header.className = "district-header";
            header.textContent = `【${district}】`;
            sidebar.appendChild(header);

            grouped[district].forEach(entry => {
              const name = entry['施設名'];
              const query = name;
              const station = entry['最寄り駅'] || "";
              const person = entry['訪問先対応者'] || "";
              const note = entry['その他特記事項'] || "";
              const visitor = entry['訪問者'] || "";

              if (!query) return;

              geocoder.geocode({ address: query }, (results, status) => {
                if (status === "OK") {
                  const position = results[0].geometry.location;
                  const infoWindow = new google.maps.InfoWindow({
                    content: `
                      <div style="text-align:left;line-height:1.4;">
                        <strong>${name}</strong><br>
                        最寄り駅：${station}<br>
                        対応者：${person}<br>
                        備考：${note}<br>
                        訪問者：${visitor}
                      </div>`
                  });

                  const marker = new google.maps.Marker({
                    map: map,
                    position: position,
                    title: name
                  });

                  marker.addListener("click", () => {
                    closeAllInfoWindows();
                    map.panTo(marker.getPosition());
                    infoWindow.open(map, marker);
                  });

                  markers.push(marker);
                  infoWindows.push(infoWindow);

                  const item = document.createElement("div");
                  item.className = "list-item";
                  item.textContent = name;
                  item.addEventListener("click", () => {
                    closeAllInfoWindows();
                    map.panTo(marker.getPosition());
                    map.setZoom(16);
                    infoWindow.open(map, marker);
                  });
                  sidebar.appendChild(item);
                } else {
                  console.error("ジオコーディング失敗: " + status + "（施設名: " + query + "）");
                }
              });
            });
          }

          const closeBtn = document.createElement("button");
          closeBtn.id = "close-button";
          closeBtn.textContent = "❌ すべての吹き出しを閉じる";
          closeBtn.addEventListener("click", () => {
            closeAllInfoWindows();
          });
          sidebar.prepend(closeBtn);
        }

        function closeAllInfoWindows() {
          infoWindows.forEach(win => win.close());
        }
      }
    </script>
  </head>
  <body>
    <div id="sidebar"></div>
    <div id="map"></div>
  </body>
</html>
